<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rutinitas Harian</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 12px;
}
h1, h2 {
  margin-top: 10px;
}
.task {
  background: #fff;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
}
.task b {
  font-size: 15px;
}
img {
  width: 100%;
  max-height: 300px;
  object-fit: cover;
  border-radius: 8px;
  margin-top: 6px;
}
button {
  margin-top: 6px;
  padding: 6px 10px;
}
small {
  color: #555;
}
.section {
  margin-top: 25px;
}
</style>
</head>

<body>

<h1>Rutinitas Harian</h1>

<label>Pilih Tanggal:</label><br>
<input type="date" id="datePicker">
<button onclick="loadDay()">Muat</button>

<div id="taskList"></div>

<div class="section">
<h2>Riwayat Harian</h2>
<button onclick="showDailyHistory()">Lihat Riwayat Harian</button>
<div id="dailyHistory"></div>
</div>

<div class="section">
<h2>Rekap Bulanan</h2>
<input type="month" id="monthPicker">
<button onclick="showMonthlyHistory()">Lihat Rekap Bulanan</button>
<div id="monthlyHistory"></div>
</div>

<script>
// ================= DATA RUTINITAS =================
const routines = [
 "04.30 Mandi Pagi",
 "04.50 Shalat Fajar",
 "04.55 Shalat Subuh",
 "05.05 Dzikir Pagi",
 "05.15 Sapu Pel Rumah",
 "06.30 Olahraga 15 Menit",
 "07.30 Duolingo Matematika 500 XP",
 "08.00 Duolingo Bahasa Inggris 500 XP",
 "09.00 Pembersihan Cicilan",

 "12.15 Shalat Dzuhur",
 "12.45 Mahkota Pengantin (1 Judul)",
 "14.00 Baca Buku Target (1 Bab)",

 "15.35 Shalat Ashar",
 "15.45 Dzikir Petang",
 "17.00 Mandi Sore",
 "18.10 Shalat Maghrib",
 "19.25 Shalat Isya",

 "22.00 Tidur"
];

// ================= DATABASE =================
let db;
const request = indexedDB.open("RutinitasDB", 1);

request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("records", { keyPath: "id" });
};

request.onsuccess = e => {
  db = e.target.result;
  document.getElementById("datePicker").valueAsDate = new Date();
  loadDay();
};

// ================= LOAD HARIAN =================
function loadDay() {
  const date = datePicker.value;
  const container = document.getElementById("taskList");
  container.innerHTML = "";

  routines.forEach(task => {
    const id = date + "_" + task;
    container.innerHTML += `
      <div class="task">
        <b>${task}</b><br>
        <input type="file" accept="image/*" onchange="savePhoto(event,'${id}')">
        <div id="${id}"></div>
      </div>
    `;
    loadPhoto(id);
  });
}

// ================= SIMPAN FOTO =================
function savePhoto(e, id) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const time = new Date().toLocaleTimeString();
    const tx = db.transaction("records", "readwrite");
    tx.objectStore("records").put({
      id: id,
      img: reader.result,
      time: time
    });
    loadPhoto(id);
  };
  reader.readAsDataURL(file);
}

// ================= LOAD FOTO =================
function loadPhoto(id) {
  const tx = db.transaction("records", "readonly");
  const req = tx.objectStore("records").get(id);

  req.onsuccess = () => {
    const el = document.getElementById(id);
    if (req.result) {
      el.innerHTML = `
        <img src="${req.result.img}">
        <small>Upload: ${req.result.time}</small><br>
        <button onclick="deletePhoto('${id}')">Hapus / Ganti Foto</button>
      `;
    } else {
      el.innerHTML = "";
    }
  };
}

// ================= HAPUS FOTO =================
function deletePhoto(id) {
  const tx = db.transaction("records", "readwrite");
  tx.objectStore("records").delete(id);
  loadPhoto(id);
}

// ================= RIWAYAT HARIAN =================
function showDailyHistory() {
  const out = document.getElementById("dailyHistory");
  out.innerHTML = "";

  const tx = db.transaction("records", "readonly");
  tx.objectStore("records").openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      out.innerHTML += `<div>${cursor.key} — ${cursor.value.time}</div>`;
      cursor.continue();
    }
  };
}

// ================= REKAP BULANAN =================
function showMonthlyHistory() {
  const month = document.getElementById("monthPicker").value;
  const out = document.getElementById("monthlyHistory");
  out.innerHTML = "";

  const tx = db.transaction("records", "readonly");
  tx.objectStore("records").openCursor().onsuccess = e => {
    const cursor = e.target.result;
    if (cursor) {
      if (cursor.key.startsWith(month)) {
        out.innerHTML += `<div>${cursor.key} — ${cursor.value.time}</div>`;
      }
      cursor.continue();
    }
  };
}
</script>

</body>
</html>